
# Analysis w/ NICHES
Vignette: https://msraredon.github.io/NICHES/articles/04%20Differential%20CellToCell.html

```{r}
library(Seurat)
library(ggplot2)
library(dplyr)
library(scales)
library(NICHES)
library(stringr)


source("/home/dwm269/DWM_utils/sc_utils/seurat_helpers/seutils.R")
source("/home/dwm269/DWM_utils/sc_utils/seurat_helpers/seuplots.R")
source("/home/dwm269/DWM_utils/plotting_utils/scThemes.R")
scTheme <- scThemes()
```

```{r setup}
knitr::opts_knit$set(root.dir = "/workdir/dwm269/scCardiacOrganoid/")
```


Load a snd split Seurat object
```{r}
# scco.seu <- readRDS("data/robjs/scCO_v7-2.rds")

seu.list <- SplitObject(
  scco.seu,
  split.by = "sample"
)
```

# Run NICHES
```{r}
# Run NICHES on each system and store/name the outputs
scc.list <- list()
for(i in 1:length(seu.list)){
  scc.list[[i]] <- RunNICHES(
    seu.list[[i]],
    LR.database="fantom5",
    species="human",
    assay="counts",
    cell_types = "cell_types",
    min.cells.per.ident=1,
    min.cells.per.gene = 50,
    meta.data.to.map = c('sample','cell_types','pattern'),
    SystemToCell = T,
    CellToCell = T
  )
}

names(scc.list) <- names(seu.list)
```


Isolate output of interest
```{r}
temp.list <- list()
for(i in 1:length(scc.list)){
    temp.list[[i]] <- scc.list[[i]]$CellToCell # Isolate CellToCell Signaling, which is all that will be covered in this vignette
    temp.list[[i]]$Condition <- names(scc.list)[i] # Tag with metadata
}
```


```{r}
# Merge together
scc.merge <- merge(temp.list[[1]],temp.list[1:length(temp.list)])
```


```{r}
# Clean up low-information crosses (connectivity data can be very sparse)
VlnPlot(
  scc.merge,
  features = 'nFeature_CellToCell',
  group.by = 'Condition',
  pt.size=0,
  log = T
)
```

subset/QC filter the cell-cell interactions
```{r}
# Requesting at least 5 distinct ligand-receptor interactions between two cells
scc.sub <- subset(
  scc.merge,
  nFeature_CellToCell > 5
) 
```

Visualize full dataset
```{r}
scc.sub <- NormalizeData(scc.sub)
scc.sub <- ScaleData(scc.sub)
scc.sub <- FindVariableFeatures(
  scc.sub,
  # nfeatures = 200,
  selection.method = "disp"
)

scc.sub <- RunPCA(
  scc.sub,
  npcs = 50
)

ElbowPlot(
  scc.sub,
  ndim=50
)+
  scTheme$scatter
```

```{r}
scc.sub <- RunUMAP(scc.sub,dims = 1:25)

DimPlot(
  scc.sub,
  group.by = 'VectorType'
  )+
  scTheme$umap+NoLegend()
```

```{r}
DimPlot(scc.sub,group.by = 'Condition')+
  scTheme$umap
```

```{r}
DimPlot(scc.sub,group.by = 'ReceivingType')+
  scTheme$umap
```

```{r}
DimPlot(scc.sub,group.by = 'SendingType')+
  scTheme$umap
```

```{r}
head(unique(scc.sub@meta.data$VectorType))

```


Define VectorTypes of interest (note the long em-dash used in NICHES)
```{r}
VOI <- "CD14 Monoï¿½DC"
# Loop over VectorTypes of interest, subsetting those interactions, finding markers associated with the comparison of interest (stimulus vs control) and  create a heatmap of top markers:
lapply(VOI, function(x){
    
    #subset
    subs <- subset(scc.sub, subset = VectorType == x)
    
    #print number of cells per condition
    print(paste0(x , ":  CTRL:", sum(subs@meta.data$Condition == "CTRL")))
    print(paste0(x , ":  STIM:", sum(subs@meta.data$Condition == "STIM")))
    
    #set idents
    Idents(subs) <- subs@meta.data$Condition
    
    #scale the subsetted data
    FindVariableFeatures(subs,assay='CellToCell',selection.method = "disp")
    ScaleData(subs, assay='CellToCell')
    
    #these are the features in the scaledata slot
    feats <- dimnames(subs@assays$CellToCell@scale.data)[[1]]
    feats
    
    #find markers (here we use wilcox, but ROC and other tests can be used as well)
    markers <- FindAllMarkers(subs, features=feats, test.use = "wilcox",assay='CellToCell')
    
    #subset to top 10 markers per condition
    top10 <- markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC)
    
    #Make a heatmap
    DoHeatmap(subs,group.by="ident",features=top10$gene, assay="CellToCell") +  ggtitle("Top DE Mechanisms, CTRL vs STIM: ",x)
})
```


```{r}

```


```{r}

```


```{r}

```


```{r}

```

